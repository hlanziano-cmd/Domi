<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Domicilios - Sistema Profesional</title>
    
    <!-- Firebase PRIMERO -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <!-- Luego React -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        * { box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; 
            margin: 0; padding: 0; background-color: #f8fafc; line-height: 1.6;
        }
        .loading { 
            display: flex; justify-content: center; align-items: center; height: 100vh; 
            font-size: 18px; color: #6B7280; flex-direction: column; 
        }
        .spinner { 
            border: 3px solid #f3f4f6; border-top: 3px solid #3b82f6; border-radius: 50%; 
            width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 16px; 
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .metric-card { 
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out; 
            cursor: pointer;
        }
        .metric-card:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1); }
        .btn-primary { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            transition: all 0.3s ease; border: none; outline: none;
        }
        .btn-primary:hover { 
            transform: translateY(-1px); 
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4); 
        }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .notification { 
            position: fixed; top: 20px; right: 20px; z-index: 1000; 
            color: white; padding: 12px 16px; 
            border-radius: 8px; font-size: 14px; font-weight: 500;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
        .bg-green-500 { background-color: #10B981; }
        .bg-red-500 { background-color: #EF4444; }
        .bg-blue-500 { background-color: #3B82F6; }
        .bg-yellow-500 { background-color: #F59E0B; }
    </style>
</head>
<body>
    <div id="root">
        <div class="loading">
            <div class="spinner"></div>
            <p>Iniciando Sistema de Control de Domicilios...</p>
        </div>
    </div>

    <script type="text/babel">
        const { useState, useEffect, useCallback } = React;

        // Verificar Firebase
        if (typeof firebase === 'undefined') {
            document.getElementById('root').innerHTML = '<div class="loading"><p style="color: red;">Error: Firebase no cargó. Recarga la página.</p></div>';
            throw new Error('Firebase no disponible');
        }

        // Inicializar Firebase
        firebase.initializeApp({
            apiKey: "AIzaSyAR79k-vcBkosnierK1igpFvm20j_6Uyaw",
            authDomain: "domi-67785.firebaseapp.com",
            projectId: "domi-67785",
            storageBucket: "domi-67785.firebasestorage.app",
            messagingSenderId: "334983627289",
            appId: "1:334983627289:web:7dc0737c07f93aa1a76088"
        });

        const db = firebase.firestore();
        console.log('Firebase OK');

        // Componentes
        const Icon = ({ d, className = "w-4 h-4", style }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" style={style}>
                <path d={d} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
            </svg>
        );

        const icons = {
            plus: "M12 5v14m7-7H5",
            trending: "M13 7h8m0 0v8m0-8l-8 8-4-4-6 6",
            package: "M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4M4 7l8 4M4 7v10l8 4m0-10v10",
            users: "M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2m18 0-3-3m-8-8a4 4 0 1 1-8 0 4 4 0 0 1 8 0",
            star: "M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2",
            clock: "M12 6v6l4 2m6-2a10 10 0 1 1-20 0 10 10 0 0 1 20 0",
            dollar: "M12 1v22M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6",
            smartphone: "M5 2h14a2 2 0 0 1 2 2v16a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2m7 16h.01",
            edit: "M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7m-9.5-9.5L21 3l-9.5 9.5-4 1 1-4Z",
            trash: "M3 6h18M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2m3 0v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6",
            send: "M22 2L11 13m11-11L15 22l-4-9-9-4 20-9",
            alert: "M12 8v4m0 4h.01M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0",
            mapPin: "M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0m-5 0a4 4 0 1 1-8 0 4 4 0 0 1 8 0",
            close: "M18 6L6 18M6 6l12 12"
        };

        const Notification = ({ message, type, onClose }) => {
            useEffect(() => {
                const t = setTimeout(onClose, 3000);
                return () => clearTimeout(t);
            }, [onClose]);
            return <div className={`notification bg-${type}-500`}>{message}</div>;
        };

        const DeliverySystem = () => {
            const [activeTab, setActiveTab] = useState('dashboard');
            const [orders, setOrders] = useState([]);
            const [deliveryPersons, setDeliveryPersons] = useState([]);
            const [locations, setLocations] = useState({});
            const [loading, setLoading] = useState(true);
            const [notifications, setNotifications] = useState([]);
            const [isDeliveryPersonView, setIsDeliveryPersonView] = useState(false);
            const [currentDeliveryPerson, setCurrentDeliveryPerson] = useState(null);
            const [isTrackingLocation, setIsTrackingLocation] = useState(false);
            const [viewingLocation, setViewingLocation] = useState(null);
            const [newOrder, setNewOrder] = useState({
                customerName: '', address: '', orderValue: '', deliveryFee: '', 
                deliveryPerson: '', city: '', customerPhone: ''
            });
            const [newDeliveryPerson, setNewDeliveryPerson] = useState({
                name: '', phone: '+57 ', vehicle: 'moto'
            });

            const colombianCities = ['Bogotá', 'Medellín', 'Cali', 'Barranquilla', 'Cartagena', 'Cúcuta', 'Bucaramanga', 'Pereira', 'Santa Marta', 'Ibagué'];

            const showNotification = useCallback((message, type = 'success') => {
                setNotifications(prev => [...prev, { id: Date.now(), message, type }]);
            }, []);

            const formatNumber = (num) => {
                if (!num) return '0';
                return Math.round(num).toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.');
            };

            useEffect(() => {
                const loadData = async () => {
                    try {
                        const [ordersSnap, personsSnap, locsSnap] = await Promise.all([
                            db.collection('orders').get(),
                            db.collection('deliveryPersons').get(),
                            db.collection('locations').get()
                        ]);

                        setOrders(ordersSnap.docs.map(d => ({ id: d.id, ...d.data() })));
                        const persons = personsSnap.docs.map(d => ({ id: d.id, ...d.data(), numericId: d.data().numericId || d.id }));
                        setDeliveryPersons(persons);
                        
                        const locs = {};
                        locsSnap.docs.forEach(d => locs[d.id] = d.data());
                        setLocations(locs);

                        const urlParams = new URLSearchParams(window.location.search);
                        const deliveryPersonId = urlParams.get('repartidor');

                        if (deliveryPersonId) {
                            const person = persons.find(p => p.numericId === deliveryPersonId);
                            if (person) {
                                setIsDeliveryPersonView(true);
                                setCurrentDeliveryPerson(person);
                                setTimeout(() => {
                                    showNotification(`Bienvenido ${person.name}`, 'success');
                                    setLoading(false);
                                }, 1000);
                            } else {
                                setTimeout(() => {
                                    showNotification('Repartidor no encontrado', 'error');
                                    setLoading(false);
                                }, 1000);
                            }
                        } else {
                            setTimeout(() => {
                                showNotification('Sistema cargado', 'success');
                                setLoading(false);
                            }, 1000);
                        }
                    } catch (error) {
                        console.error('Error:', error);
                        showNotification('Error: ' + error.message, 'error');
                        setLoading(false);
                    }
                };
                loadData();
            }, [showNotification]);

            useEffect(() => {
                const uns = db.collection('orders').onSnapshot(s => setOrders(s.docs.map(d => ({ id: d.id, ...d.data() }))));
                return uns;
            }, []);

            useEffect(() => {
                const uns = db.collection('deliveryPersons').onSnapshot(s => 
                    setDeliveryPersons(s.docs.map(d => ({ id: d.id, ...d.data(), numericId: d.data().numericId || d.id })))
                );
                return uns;
            }, []);

            useEffect(() => {
                const uns = db.collection('locations').onSnapshot(s => {
                    const locs = {};
                    s.docs.forEach(d => locs[d.id] = d.data());
                    setLocations(locs);
                });
                return uns;
            }, []);

            const calculateMetrics = useCallback(() => {
                if (!orders.length) return {
                    totalOrders: 0, totalRevenue: 0, avgDeliveryTime: 0, avgOrderValue: 0,
                    completionRate: 0, avgRating: 0, completedOrders: 0, activeOrders: 0, pendingOrders: 0
                };

                const completed = orders.filter(o => o.status === 'entregado');
                const active = orders.filter(o => o.status === 'en_transito');
                const pending = orders.filter(o => o.status === 'pendiente');
                const totalRevenue = orders.reduce((s, o) => s + parseFloat(o.orderValue || 0) + parseFloat(o.deliveryFee || 0), 0);
                const times = completed.filter(o => o.actualDeliveryTime).map(o => parseInt(o.actualDeliveryTime));
                const avgTime = times.length ? times.reduce((s, t) => s + t, 0) / times.length : 0;
                const ratings = completed.filter(o => o.rating).map(o => parseInt(o.rating));
                const avgRating = ratings.length ? ratings.reduce((s, r) => s + r, 0) / ratings.length : 0;

                return {
                    totalOrders: orders.length,
                    completedOrders: completed.length,
                    activeOrders: active.length,
                    pendingOrders: pending.length,
                    totalRevenue,
                    avgDeliveryTime: Math.round(avgTime),
                    avgOrderValue: totalRevenue / orders.length,
                    completionRate: (completed.length / orders.length) * 100,
                    avgRating
                };
            }, [orders]);

            const handleAddOrder = useCallback(async () => {
                if (!newOrder.customerName?.trim() || !newOrder.address?.trim() || !newOrder.orderValue) {
                    showNotification('Completa campos obligatorios', 'warning');
                    return;
                }
                try {
                    await db.collection('orders').add({
                        ...newOrder,
                        customerName: newOrder.customerName.trim(),
                        address: newOrder.address.trim(),
                        orderValue: parseFloat(newOrder.orderValue),
                        deliveryFee: parseFloat(newOrder.deliveryFee || 0),
                        status: 'pendiente',
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    });
                    setNewOrder({ customerName: '', address: '', orderValue: '', deliveryFee: '', deliveryPerson: '', city: '', customerPhone: '' });
                    showNotification('Pedido creado', 'success');
                } catch (error) {
                    showNotification('Error: ' + error.message, 'error');
                }
            }, [newOrder, showNotification]);

            const handleAddDeliveryPerson = useCallback(async () => {
                if (!newDeliveryPerson.name?.trim()) {
                    showNotification('Ingresa nombre', 'warning');
                    return;
                }
                try {
                    await db.collection('deliveryPersons').add({
                        ...newDeliveryPerson,
                        name: newDeliveryPerson.name.trim(),
                        numericId: Date.now().toString(),
                        createdAt: new Date().toISOString(),
                        totalDeliveries: 0
                    });
                    setNewDeliveryPerson({ name: '', phone: '+57 ', vehicle: 'moto' });
                    showNotification('Repartidor agregado', 'success');
                } catch (error) {
                    showNotification('Error: ' + error.message, 'error');
                }
            }, [newDeliveryPerson, showNotification]);

            const handleDelete = useCallback(async (id) => {
                const person = deliveryPersons.find(p => p.id === id);
                if (!person) return;
                const hasActive = orders.some(o => o.deliveryPerson === person.name && (o.status === 'pendiente' || o.status === 'en_transito'));
                if (hasActive) {
                    showNotification('Tiene pedidos activos', 'error');
                    return;
                }
                if (confirm(`¿Eliminar a ${person.name}?`)) {
                    try {
                        await db.collection('deliveryPersons').doc(id).delete();
                        showNotification('Eliminado', 'info');
                    } catch (error) {
                        showNotification('Error: ' + error.message, 'error');
                    }
                }
            }, [deliveryPersons, orders, showNotification]);

            const handleEdit = useCallback(async (id) => {
                const person = deliveryPersons.find(p => p.id === id);
                if (!person) return;
                const newName = prompt('Nuevo nombre:', person.name);
                const newPhone = prompt('Nuevo teléfono:', person.phone);
                if (newName?.trim()) {
                    try {
                        await db.collection('deliveryPersons').doc(id).update({
                            name: newName.trim(),
                            phone: newPhone || person.phone
                        });
                        showNotification('Actualizado', 'success');
                    } catch (error) {
                        showNotification('Error: ' + error.message, 'error');
                    }
                }
            }, [deliveryPersons, showNotification]);

            const sendWhatsApp = useCallback((person) => {
                const url = `${window.location.origin}${window.location.pathname}?repartidor=${person.numericId}`;
                const msg = encodeURIComponent(
                    `Hola ${person.name}\n\nEnlace: ${url}\n\nAbre en tu celular y activa GPS cuando tengas pedidos.`
                );
                const phone = person.phone.replace(/\D/g, '').slice(-10);
                if (phone) {
                    window.open(`https://wa.me/57${phone}?text=${msg}`, '_blank');
                    showNotification('Enviado', 'success');
                } else {
                    showNotification('Teléfono inválido', 'error');
                }
            }, [showNotification]);

            const updateStatus = useCallback(async (id, status) => {
                try {
                    await db.collection('orders').doc(id).update({ status, updatedAt: new Date().toISOString() });
                    showNotification(status === 'en_transito' ? 'Enviado' : 'Completado', 'success');
                } catch (error) {
                    showNotification('Error: ' + error.message, 'error');
                }
            }, [showNotification]);

            const completeDelivery = useCallback(async (id, time, rating) => {
                try {
                    await db.collection('orders').doc(id).update({
                        status: 'entregado',
                        actualDeliveryTime: time,
                        rating,
                        completedAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    });
                    showNotification('Completado', 'success');
                } catch (error) {
                    showNotification('Error: ' + error.message, 'error');
                }
            }, [showNotification]);

            const startGPS = useCallback(() => {
                if (!navigator.geolocation) {
                    showNotification('GPS no soportado', 'error');
                    return;
                }
                setIsTrackingLocation(true);
                showNotification('GPS activado', 'info');
                navigator.geolocation.watchPosition(
                    async (pos) => {
                        if (currentDeliveryPerson) {
                            try {
                                await db.collection('locations').doc(currentDeliveryPerson.id).set({
                                    lat: pos.coords.latitude,
                                    lng: pos.coords.longitude,
                                    timestamp: new Date().toISOString()
                                });
                            } catch (e) {}
                        }
                    },
                    (e) => console.error(e),
                    { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
                );
            }, [currentDeliveryPerson, showNotification]);

            const stopGPS = useCallback(() => {
                setIsTrackingLocation(false);
                showNotification('GPS desactivado', 'info');
            }, [showNotification]);

            const acceptOrder = useCallback((id) => {
                updateStatus(id, 'en_transito');
                if (!isTrackingLocation) startGPS();
            }, [isTrackingLocation, startGPS, updateStatus]);

            const contactCustomer = useCallback((phone) => {
                const clean = phone.replace(/\D/g, '').slice(-10);
                if (clean) window.open(`https://wa.me/57${clean}`, '_blank');
                else showNotification('Sin teléfono', 'error');
            }, [showNotification]);

            const metrics = calculateMetrics();

            const MetricCard = ({ title, value, icon, color, prefix = "", suffix = "" }) => (
                <div className="metric-card bg-white rounded-xl shadow-lg p-6 border-2 border-gray-100 hover:border-gray-200 fade-in">
                    <div className="flex items-center justify-between">
                        <div className="flex-1">
                            <p className="text-sm font-medium text-gray-600 mb-1">{title}</p>
                            <p className="text-2xl font-bold text-gray-900">{prefix}{typeof value === 'number' ? formatNumber(value) : value}{suffix}</p>
                        </div>
                        <div className="ml-4 flex-shrink-0">
                            <div className="w-12 h-12 rounded-xl flex items-center justify-center shadow-md" style={{ backgroundColor: color + '15' }}>
                                <Icon d={icon} className="w-6 h-6" style={{ color }} />
                            </div>
                        </div>
                    </div>
                </div>
            );

            const tabs = [
                { id: 'dashboard', name: 'Dashboard', icon: icons.trending },
                { id: 'orders', name: 'Pedidos', icon: icons.package },
                { id: 'delivery', name: 'Repartidores', icon: icons.users },
                { id: 'analytics', name: 'Análisis', icon: icons.star }
            ];

            if (loading) return <div className="loading"><div className="spinner"></div><p>Cargando...</p></div>;

            // Vista Repartidor
            if (isDeliveryPersonView && currentDeliveryPerson) {
                const myOrders = orders.filter(o => o.deliveryPerson === currentDeliveryPerson.name);
                const pending = myOrders.filter(o => o.status === 'pendiente');
                const active = myOrders.filter(o => o.status === 'en_transito');
                const completed = myOrders.filter(o => o.status === 'entregado');

                return (
                    <div className="min-h-screen bg-gradient-to-br from-green-50 via-blue-50 to-purple-50">
                        {notifications.map(n => <Notification key={n.id} {...n} onClose={() => setNotifications(p => p.filter(i => i.id !== n.id))} />)}
                        <div className="bg-gradient-to-r from-green-600 to-blue-600 text-white shadow-lg">
                            <div className="max-w-4xl mx-auto px-4 py-6 flex items-center justify-between">
                                <div>
                                    <h1 className="text-2xl font-bold">Hola, {currentDeliveryPerson.name}</h1>
                                    <p className="text-green-100 text-sm">Panel de Repartidor</p>
                                </div>
                                <button onClick={isTrackingLocation ? stopGPS : startGPS}
                                    className={`px-4 py-2 rounded-lg font-medium text-sm ${isTrackingLocation ? 'bg-red-500 hover:bg-red-600' : 'bg-white text-green-600'}`}>
                                    {isTrackingLocation ? 'GPS: Activo' : 'Activar GPS'}
                                </button>
                            </div>
                        </div>
                        <div className="max-w-4xl mx-auto px-4 py-6 space-y-6">
                            <div className="grid grid-cols-3 gap-4">
                                <div className="bg-white rounded-xl p-4 shadow-lg border-2 border-yellow-200">
                                    <div className="text-2xl font-bold text-yellow-600">{pending.length}</div>
                                    <div className="text-sm text-gray-600">Pendientes</div>
                                </div>
                                <div className="bg-white rounded-xl p-4 shadow-lg border-2 border-blue-200">
                                    <div className="text-2xl font-bold text-blue-600">{active.length}</div>
                                    <div className="text-sm text-gray-600">En Ruta</div>
                                </div>
                                <div className="bg-white rounded-xl p-4 shadow-lg border-2 border-green-200">
                                    <div className="text-2xl font-bold text-green-600">{completed.length}</div>
                                    <div className="text-sm text-gray-600">Completadas</div>
                                </div>
                            </div>

                            {pending.length > 0 && (
                                <div className="bg-white rounded-xl shadow-lg border-2 border-yellow-200">
                                    <div className="px-6 py-4 bg-yellow-50 border-b border-yellow-200">
                                        <h3 className="text-lg font-semibold">Pedidos Disponibles</h3>
                                    </div>
                                    <div className="p-4 space-y-4">
                                        {pending.map(o => (
                                            <div key={o.id} className="bg-yellow-50 rounded-lg p-4 border-2 border-yellow-200">
                                                <div className="flex justify-between mb-3">
                                                    <div>
                                                        <h4 className="font-bold text-lg">{o.customerName}</h4>
                                                        <p className="text-sm text-gray-600">{o.address}</p>
                                                        {o.city && <p className="text-xs text-gray-500">{o.city}</p>}
                                                    </div>
                                                    <div className="text-right">
                                                        <div className="text-lg font-bold text-green-600">${formatNumber(o.orderValue)}</div>
                                                        {o.deliveryFee > 0 && <div className="text-sm text-gray-600">+ ${formatNumber(o.deliveryFee)}</div>}
                                                    </div>
                                                </div>
                                                <div className="flex gap-2">
                                                    <button onClick={() => acceptOrder(o.id)} className="flex-1 bg-green-600 hover:bg-green-700 text-white px-4 py-3 rounded-lg font-medium">
                                                        Aceptar
                                                    </button>
                                                    {o.customerPhone && (
                                                        <button onClick={() => contactCustomer(o.customerPhone)} className="bg-green-500 hover:bg-green-600 text-white px-4 py-3 rounded-lg">
                                                            <Icon d={icons.smartphone} className="w-5 h-5" />
                                                        </button>
                                                    )}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {active.length > 0 && (
                                <div className="bg-white rounded-xl shadow-lg border-2 border-blue-200">
                                    <div className="px-6 py-4 bg-blue-50 border-b border-blue-200">
                                        <h3 className="text-lg font-semibold">En Ruta</h3>
                                    </div>
                                    <div className="p-4 space-y-4">
                                        {active.map(o => (
                                            <div key={o.id} className="bg-blue-50 rounded-lg p-4 border-2 border-blue-200">
                                                <div className="flex justify-between mb-3">
                                                    <div>
                                                        <h4 className="font-bold text-lg">{o.customerName}</h4>
                                                        <p className="text-sm text-gray-600">{o.address}</p>
                                                    </div>
                                                    <div className="text-lg font-bold text-green-600">${formatNumber(o.orderValue)}</div>
                                                </div>
                                                {!isTrackingLocation && (
                                                    <div className="bg-orange-100 border-2 border-orange-300 rounded-lg p-3 mb-3 flex items-start">
                                                        <Icon d={icons.alert} className="w-5 h-5 text-orange-600 mr-2 mt-0.5" />
                                                        <div className="text-sm text-orange-800"><strong>GPS desactivado.</strong> Activa GPS.</div>
                                                    </div>
                                                )}
                                                <div className="grid grid-cols-2 gap-2">
                                                    {o.customerPhone && (
                                                        <button onClick={() => contactCustomer(o.customerPhone)} 
                                                            className="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg font-medium flex items-center justify-center space-x-2">
                                                            <Icon d={icons.smartphone} className="w-4 h-4" />
                                                            <span>Contactar</span>
                                                        </button>
                                                    )}
                                                    <button onClick={() => {
                                                        const t = prompt('Minutos:', '30');
                                                        const r = prompt('Calificación (1-5):', '5');
                                                        if (t && r) completeDelivery(o.id, t, r);
                                                    }} className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium">
                                                        Completar
                                                    </button>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {completed.length > 0 && (
                                <div className="bg-white rounded-xl shadow-lg border-2 border-green-200">
                                    <div className="px-6 py-4 bg-green-50 border-b border-green-200">
                                        <h3 className="text-lg font-semibold">Historial</h3>
                                    </div>
                                    <div className="p-4 space-y-3">
                                        {completed.slice(0, 5).map(o => (
                                            <div key={o.id} className="bg-green-50 rounded-lg p-4 border border-green-200">
                                                <div className="flex justify-between">
                                                    <div>
                                                        <h4 className="font-bold">{o.customerName}</h4>
                                                        <p className="text-sm text-gray-600">{o.address}</p>
                                                    </div>
                                                    <div className="text-right">
                                                        <div className="font-bold text-green-600">${formatNumber(o.orderValue)}</div>
                                                        {o.rating && <div className="text-sm text-yellow-600">{o.rating}/5</div>}
                                                    </div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {!myOrders.length && (
                                <div className="bg-white rounded-xl shadow-lg p-12 text-center">
                                    <Icon d={icons.package} className="w-16 h-16 text-gray-300 mx-auto mb-4" />
                                    <h3 className="text-xl font-bold text-gray-900 mb-2">Sin pedidos</h3>
                                    <p className="text-gray-600">Aparecerán cuando te los asignen</p>
                                </div>
                            )}
                        </div>
                    </div>
                );
            }

            // Vista Admin
            return (
                <div className="min-h-screen bg-gradient-to-br from-gray-50 via-white to-gray-100">
                    {notifications.map(n => <Notification key={n.id} {...n} onClose={() => setNotifications(p => p.filter(i => i.id !== n.id))} />)}

                    {viewingLocation && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4" onClick={() => setViewingLocation(null)}>
                            <div className="bg-white rounded-2xl max-w-2xl w-full max-h-[90vh] overflow-hidden shadow-2xl" onClick={e => e.stopPropagation()}>
                                <div className="bg-gradient-to-r from-blue-600 to-purple-600 text-white p-6 flex justify-between items-center">
                                    <div>
                                        <h3 className="text-2xl font-bold">Ubicación de {viewingLocation.name}</h3>
                                        <p className="text-blue-100 text-sm">GPS en tiempo real</p>
                                    </div>
                                    <button onClick={() => setViewingLocation(null)} className="text-white hover:bg-white hover:bg-opacity-20 rounded-full p-2">
                                        <Icon d={icons.close} className="w-6 h-6" />
                                    </button>
                                </div>
                                <div className="p-6">
                                    {locations[viewingLocation.id] ? (
                                        <div className="space-y-4">
                                            <div className="bg-green-50 border-2 border-green-200 rounded-lg p-4">
                                                <div className="flex items-center space-x-2 mb-3">
                                                    <div className="w-3 h-3 bg-green-500 rounded-full animate-pulse"></div>
                                                    <span className="text-green-800 font-semibold">GPS Activo</span>
                                                </div>
                                                <div className="space-y-2 text-sm">
                                                    <div className="flex items-center space-x-2">
                                                        <Icon d={icons.mapPin} className="w-4 h-4 text-green-600" />
                                                        <span className="font-mono text-gray-700">Lat: {locations[viewingLocation.id].lat.toFixed(6)}</span>
                                                    </div>
                                                    <div className="flex items-center space-x-2">
                                                        <Icon d={icons.mapPin} className="w-4 h-4 text-green-600" />
                                                        <span className="font-mono text-gray-700">Lng: {locations[viewingLocation.id].lng.toFixed(6)}</span>
                                                    </div>
                                                    <div className="flex items-center space-x-2">
                                                        <Icon d={icons.clock} className="w-4 h-4 text-green-600" />
                                                        <span className="text-gray-700">Actualizado: {new Date(locations[viewingLocation.id].timestamp).toLocaleString()}</span>
                                                    </div>
                                                </div>
                                            </div>
                                            <div className="bg-gray-100 rounded-lg overflow-hidden border-2 border-gray-200">
                                                <iframe width="100%" height="400" frameBorder="0" 
                                                    src={`https://maps.google.com/maps?q=${locations[viewingLocation.id].lat},${locations[viewingLocation.id].lng}&z=15&output=embed`}
                                                    allowFullScreen></iframe>
                                            </div>
                                            <div className="flex gap-3">
                                                <a href={`https://www.google.com/maps/dir/?api=1&destination=${locations[viewingLocation.id].lat},${locations[viewingLocation.id].lng}`}
                                                    target="_blank" rel="noopener noreferrer"
                                                    className="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-4 py-3 rounded-lg font-medium text-center">
                                                    Abrir en Maps
                                                </a>
                                                <button onClick={() => {
                                                    navigator.clipboard.writeText(`${locations[viewingLocation.id].lat},${locations[viewingLocation.id].lng}`);
                                                    showNotification('Copiado', 'success');
                                                }} className="bg-gray-600 hover:bg-gray-700 text-white px-4 py-3 rounded-lg font-medium">
                                                    Copiar
                                                </button>
                                            </div>
                                        </div>
                                    ) : (
                                        <div className="text-center py-12">
                                            <Icon d={icons.mapPin} className="w-16 h-16 text-gray-300 mx-auto mb-4" />
                                            <h4 className="text-lg font-semibold text-gray-900 mb-2">Sin ubicación</h4>
                                            <p className="text-gray-600">El repartidor no ha activado GPS</p>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}

                    <div className="bg-white shadow-lg border-b-2 border-gray-200">
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                            <div className="flex justify-between items-center py-6">
                                <div className="flex items-center space-x-4">
                                    <div className="w-12 h-12 bg-gradient-to-r from-blue-600 to-purple-600 rounded-xl flex items-center justify-center shadow-lg">
                                        <Icon d={icons.package} className="w-6 h-6 text-white" />
                                    </div>
                                    <div>
                                        <h1 className="text-3xl font-bold text-gray-900">Control de Domicilios</h1>
                                        <p className="text-sm text-gray-600">Sistema v2.0 con Firebase</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div className="bg-white border-b-2 border-gray-100 sticky top-0 z-10 shadow-sm">
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                            <nav className="flex space-x-1 py-4">
                                {tabs.map(tab => (
                                    <button key={tab.id} onClick={() => setActiveTab(tab.id)}
                                        className={`flex items-center space-x-2 px-4 py-3 rounded-lg text-sm font-medium transition-all duration-300 ${
                                            activeTab === tab.id ? 'bg-gradient-to-r from-blue-600 to-purple-600 text-white shadow-lg transform scale-105' : 'text-gray-600 hover:bg-gray-100'
                                        }`}>
                                        <Icon d={tab.icon} className="w-4 h-4" />
                                        <span>{tab.name}</span>
                                    </button>
                                ))}
                            </nav>
                        </div>
                    </div>

                    <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                        {activeTab === 'dashboard' && (
                            <div className="space-y-8 fade-in">
                                <div className="text-center bg-gradient-to-r from-blue-50 via-purple-50 to-pink-50 rounded-2xl p-8 border-2 border-blue-100 shadow-lg">
                                    <h2 className="text-3xl font-bold text-gray-900 mb-3">Dashboard de Control</h2>
                                    <p className="text-gray-600 text-lg max-w-3xl mx-auto">Sistema con Firebase y GPS en tiempo real</p>
                                </div>
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                                    <MetricCard title="Total Pedidos" value={metrics.totalOrders} icon={icons.package} color="#3B82F6" />
                                    <MetricCard title="Ingresos" value={metrics.totalRevenue} icon={icons.dollar} color="#10B981" prefix="$" />
                                    <MetricCard title="Tiempo" value={metrics.avgDeliveryTime} icon={icons.clock} color="#F59E0B" suffix=" min" />
                                    <MetricCard title="Calificación" value={metrics.avgRating.toFixed(1)} icon={icons.star} color="#EF4444" suffix="/5" />
                                </div>
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                    <div className="bg-gradient-to-r from-green-50 to-green-100 border-2 border-green-200 rounded-xl p-6 text-center shadow-lg">
                                        <div className="text-4xl font-bold text-green-600 mb-2">{metrics.completedOrders}</div>
                                        <div className="text-sm font-medium text-green-800">Entregados</div>
                                    </div>
                                    <div className="bg-gradient-to-r from-yellow-50 to-yellow-100 border-2 border-yellow-200 rounded-xl p-6 text-center shadow-lg">
                                        <div className="text-4xl font-bold text-yellow-600 mb-2">{metrics.pendingOrders}</div>
                                        <div className="text-sm font-medium text-yellow-800">Pendientes</div>
                                    </div>
                                    <div className="bg-gradient-to-r from-blue-50 to-blue-100 border-2 border-blue-200 rounded-xl p-6 text-center shadow-lg">
                                        <div className="text-4xl font-bold text-blue-600 mb-2">{metrics.activeOrders}</div>
                                        <div className="text-sm font-medium text-blue-800">En Tránsito</div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {activeTab === 'orders' && (
                            <div className="space-y-6 fade-in">
                                <div className="bg-white rounded-xl shadow-lg border-2 border-gray-100 p-6">
                                    <h3 className="text-lg font-semibold mb-6 flex items-center">
                                        <Icon d={icons.plus} className="w-5 h-5 mr-2 text-blue-600" />
                                        Crear Pedido
                                    </h3>
                                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                        <input type="text" placeholder="Cliente *" value={newOrder.customerName}
                                            onChange={e => setNewOrder({...newOrder, customerName: e.target.value})}
                                            className="w-full border-2 border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500" />
                                        <input type="text" placeholder="Dirección *" value={newOrder.address}
                                            onChange={e => setNewOrder({...newOrder, address: e.target.value})}
                                            className="w-full border-2 border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500" />
                                        <select value={newOrder.city} onChange={e => setNewOrder({...newOrder, city: e.target.value})}
                                            className="w-full border-2 border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500">
                                            <option value="">Ciudad</option>
                                            {colombianCities.map(c => <option key={c} value={c}>{c}</option>)}
                                        </select>
                                        <input type="number" placeholder="Valor *" value={newOrder.orderValue}
                                            onChange={e => setNewOrder({...newOrder, orderValue: e.target.value})}
                                            className="w-full border-2 border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500" />
                                        <input type="number" placeholder="Envío" value={newOrder.deliveryFee}
                                            onChange={e => setNewOrder({...newOrder, deliveryFee: e.target.value})}
                                            className="w-full border-2 border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500" />
                                        <input type="text" placeholder="Teléfono" value={newOrder.customerPhone}
                                            onChange={e => setNewOrder({...newOrder, customerPhone: e.target.value})}
                                            className="w-full border-2 border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500" />
                                        <select value={newOrder.deliveryPerson} onChange={e => setNewOrder({...newOrder, deliveryPerson: e.target.value})}
                                            className="w-full border-2 border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500">
                                            <option value="">Repartidor</option>
                                            {deliveryPersons.map(p => <option key={p.id} value={p.name}>{p.name}</option>)}
                                        </select>
                                    </div>
                                    <button onClick={handleAddOrder}
                                        className="mt-6 btn-primary text-white px-6 py-3 rounded-lg font-medium inline-flex items-center space-x-2">
                                        <Icon d={icons.plus} className="w-4 h-4" />
                                        <span>Crear</span>
                                    </button>
                                </div>

                                <div className="bg-white rounded-xl shadow-lg border-2 border-gray-100">
                                    <div className="px-6 py-4 border-b">
                                        <h3 className="text-lg font-semibold flex items-center">
                                            <Icon d={icons.package} className="w-5 h-5 mr-2 text-blue-600" />
                                            Pedidos ({orders.length})
                                        </h3>
                                    </div>
                                    <div className="overflow-x-auto">
                                        <table className="min-w-full">
                                            <thead className="bg-gray-50">
                                                <tr>
                                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Cliente</th>
                                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Dirección</th>
                                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Repartidor</th>
                                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Valor</th>
                                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Estado</th>
                                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Acciones</th>
                                                </tr>
                                            </thead>
                                            <tbody className="bg-white divide-y divide-gray-200">
                                                {!orders.length ? (
                                                    <tr><td colSpan="6" className="px-6 py-12 text-center">
                                                        <Icon d={icons.package} className="w-16 h-16 text-gray-300 mx-auto mb-4" />
                                                        <p className="text-gray-500">Sin pedidos</p>
                                                    </td></tr>
                                                ) : orders.map(o => (
                                                    <tr key={o.id} className="hover:bg-gray-50">
                                                        <td className="px-6 py-4"><div className="font-medium">{o.customerName}</div></td>
                                                        <td className="px-6 py-4"><div className="text-sm">{o.address}</div></td>
                                                        <td className="px-6 py-4"><div className="text-sm">{o.deliveryPerson || '-'}</div></td>
                                                        <td className="px-6 py-4"><div className="text-sm font-medium">${formatNumber(o.orderValue)}</div></td>
                                                        <td className="px-6 py-4">
                                                            <span className={`px-3 py-1 text-xs font-medium rounded-full ${
                                                                o.status === 'entregado' ? 'bg-green-100 text-green-800' :
                                                                o.status === 'en_transito' ? 'bg-blue-100 text-blue-800' : 'bg-yellow-100 text-yellow-800'
                                                            }`}>
                                                                {o.status === 'entregado' ? 'Entregado' : o.status === 'en_transito' ? 'En Tránsito' : 'Pendiente'}
                                                            </span>
                                                        </td>
                                                        <td className="px-6 py-4">
                                                            {o.status === 'pendiente' && (
                                                                <button onClick={() => updateStatus(o.id, 'en_transito')}
                                                                    className="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-xs">Enviar</button>
                                                            )}
                                                            {o.status === 'en_transito' && (
                                                                <button onClick={() => {
                                                                    const t = prompt('Minutos:', '30');
                                                                    const r = prompt('Calificación (1-5):', '5');
                                                                    if (t && r) completeDelivery(o.id, t, r);
                                                                }} className="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-xs">Completar</button>
                                                            )}
                                                        </td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        )}

                        {activeTab === 'delivery' && (
                            <div className="space-y-6 fade-in">
                                <div className="bg-white rounded-xl shadow-lg border-2 border-gray-100 p-6">
                                    <h3 className="text-lg font-semibold mb-6 flex items-center">
                                        <Icon d={icons.users} className="w-5 h-5 mr-2 text-green-600" />
                                        Registrar Repartidor
                                    </h3>
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <input type="text" placeholder="Nombre *" value={newDeliveryPerson.name}
                                            onChange={e => setNewDeliveryPerson({...newDeliveryPerson, name: e.target.value})}
                                            className="w-full border-2 border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-green-500" />
                                        <input type="text" placeholder="Teléfono" value={newDeliveryPerson.phone}
                                            onChange={e => setNewDeliveryPerson({...newDeliveryPerson, phone: e.target.value})}
                                            className="w-full border-2 border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-green-500" />
                                        <select value={newDeliveryPerson.vehicle} onChange={e => setNewDeliveryPerson({...newDeliveryPerson, vehicle: e.target.value})}
                                            className="w-full border-2 border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-green-500">
                                            <option value="moto">Moto</option>
                                            <option value="bicicleta">Bicicleta</option>
                                            <option value="carro">Carro</option>
                                            <option value="pie">A pie</option>
                                        </select>
                                    </div>
                                    <button onClick={handleAddDeliveryPerson}
                                        className="mt-6 bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-medium inline-flex items-center space-x-2">
                                        <Icon d={icons.plus} className="w-4 h-4" />
                                        <span>Agregar</span>
                                    </button>
                                </div>

                                <div className="bg-white rounded-xl shadow-lg border-2 border-gray-100">
                                    <div className="px-6 py-4 border-b">
                                        <h3 className="text-lg font-semibold flex items-center">
                                            <Icon d={icons.users} className="w-5 h-5 mr-2 text-green-600" />
                                            Repartidores ({deliveryPersons.length})
                                        </h3>
                                    </div>
                                    <div className="p-6">
                                        {!deliveryPersons.length ? (
                                            <div className="text-center py-12">
                                                <Icon d={icons.users} className="w-16 h-16 text-gray-300 mx-auto mb-4" />
                                                <p className="text-gray-500">Sin repartidores</p>
                                            </div>
                                        ) : (
                                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                                {deliveryPersons.map(p => (
                                                    <div key={p.id} className="border-2 border-gray-200 rounded-lg p-6 hover:shadow-lg transition-all">
                                                        <div className="flex items-center space-x-3 mb-4">
                                                            <div className="w-12 h-12 bg-gradient-to-r from-green-400 to-blue-500 rounded-full flex items-center justify-center">
                                                                <Icon d={icons.users} className="w-6 h-6 text-white" />
                                                            </div>
                                                            <div>
                                                                <h4 className="font-bold">{p.name}</h4>
                                                                <p className="text-sm text-gray-600">{p.phone}</p>
                                                                <p className="text-xs text-gray-500 capitalize">{p.vehicle}</p>
                                                            </div>
                                                        </div>
                                                        <div className="text-sm mb-4 p-3 bg-gray-50 rounded-lg space-y-2">
                                                            <p className="flex justify-between">
                                                                <span>Completadas:</span>
                                                                <span className="font-bold">{orders.filter(o => o.deliveryPerson === p.name && o.status === 'entregado').length}</span>
                                                            </p>
                                                            <p className="flex justify-between">
                                                                <span>Activos:</span>
                                                                <span className="font-bold">{orders.filter(o => o.deliveryPerson === p.name && o.status !== 'entregado').length}</span>
                                                            </p>
                                                        </div>
                                                        <div className="flex flex-wrap gap-2">
                                                            <button onClick={() => setViewingLocation(p)}
                                                                className="flex-1 bg-purple-500 hover:bg-purple-600 text-white px-3 py-2 rounded-lg text-xs font-medium flex items-center justify-center space-x-1">
                                                                <Icon d={icons.mapPin} className="w-3 h-3" />
                                                                <span>Ubicación</span>
                                                            </button>
                                                            <button onClick={() => sendWhatsApp(p)}
                                                                className="flex-1 bg-green-500 hover:bg-green-600 text-white px-3 py-2 rounded-lg text-xs font-medium flex items-center justify-center space-x-1">
                                                                <Icon d={icons.send} className="w-3 h-3" />
                                                                <span>Enviar</span>
                                                            </button>
                                                        </div>
                                                        <div className="flex gap-2 mt-2">
                                                            <button onClick={() => handleEdit(p.id)}
                                                                className="flex-1 bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded-lg text-xs">
                                                                <Icon d={icons.edit} className="w-3 h-3 mx-auto" />
                                                            </button>
                                                            <button onClick={() => handleDelete(p.id)}
                                                                className="flex-1 bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded-lg text-xs">
                                                                <Icon d={icons.trash} className="w-3 h-3 mx-auto" />
                                                            </button>
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>
                        )}

                        {activeTab === 'analytics' && (
                            <div className="space-y-6 fade-in">
                                <div className="bg-white rounded-xl shadow-lg border-2 border-gray-100 p-6">
                                    <h3 className="text-lg font-semibold mb-4 flex items-center">
                                        <Icon d={icons.trending} className="w-5 h-5 mr-2 text-blue-500" />
                                        Análisis
                                    </h3>
                                    <div className="space-y-4">
                                        <div className="flex justify-between items-center p-3 bg-green-50 rounded-lg">
                                            <span className="font-medium">Completados
			</span>
                                            <span className="font-bold text-green-600 text-lg">{metrics.completedOrders}</span>
                                        </div>
                                        <div className="flex justify-between items-center p-3 bg-blue-50 rounded-lg">
                                            <span className="font-medium">Tasa de éxito</span>
                                            <span className="font-bold text-blue-600 text-lg">{metrics.completionRate.toFixed(1)}%</span>
                                        </div>
                                        <div className="flex justify-between items-center p-3 bg-orange-50 rounded-lg">
                                            <span className="font-medium">Tiempo promedio</span>
                                            <span className="font-bold text-orange-600 text-lg">{metrics.avgDeliveryTime} min</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        ReactDOM.render(<DeliverySystem />, document.getElementById('root'));
    </script>
</body>
</html>								