<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Domicilios - Sistema Profesional</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        * { box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; 
            margin: 0; padding: 0; background-color: #f8fafc; line-height: 1.6;
        }
        .loading { 
            display: flex; justify-content: center; align-items: center; height: 100vh; 
            font-size: 18px; color: #6B7280; flex-direction: column; 
        }
        .spinner { 
            border: 3px solid #f3f4f6; border-top: 3px solid #3b82f6; border-radius: 50%; 
            width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 16px; 
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .metric-card { 
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out; 
            cursor: pointer;
        }
        .metric-card:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        .tab-button {
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }
        .tab-button.active { border-bottom-color: #3b82f6; color: #3b82f6; font-weight: 600; }
        .pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .7; } }
        .gps-indicator {
            width: 12px; height: 12px; border-radius: 50%; display: inline-block;
            margin-right: 6px; animation: pulse-gps 2s ease-in-out infinite;
        }
        @keyframes pulse-gps {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }
        .timer-display {
            font-family: 'Courier New', monospace;
            font-weight: bold;
            font-size: 1.3em;
            color: #dc2626;
            background: #fee;
            padding: 8px 16px;
            border-radius: 8px;
            display: inline-block;
            border: 2px solid #fca5a5;
        }
        .gps-warning-banner {
            animation: shake 0.5s ease-in-out;
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Configuración de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBxample_API_KEY",
            authDomain: "tu-proyecto.firebaseapp.com",
            databaseURL: "https://tu-proyecto-default-rtdb.firebaseio.com",
            projectId: "tu-proyecto",
            storageBucket: "tu-proyecto.appspot.com",
            messagingSenderId: "123456789012",
            appId: "1:123456789012:web:abc123"
        };

        // Gestor de base de datos con Firebase y fallback a localStorage
        class DatabaseManager {
            constructor() {
                this.useFirebase = false;
                this.db = null;
                this.listeners = {};
                this.initFirebase();
            }

            async initFirebase() {
                try {
                    if (typeof firebase !== 'undefined' && firebaseConfig.apiKey !== "AIzaSyBxample_API_KEY") {
                        if (!firebase.apps.length) {
                            firebase.initializeApp(firebaseConfig);
                        }
                        this.db = firebase.database();
                        this.useFirebase = true;
                        console.log("? Firebase inicializado correctamente");
                    } else {
                        console.log("?? Usando localStorage como almacenamiento");
                    }
                } catch (error) {
                    console.log("?? Error en Firebase, usando localStorage:", error);
                    this.useFirebase = false;
                }
            }

            async saveData(key, data) {
                if (this.useFirebase && this.db) {
                    await this.db.ref(key).set(data);
                } else {
                    localStorage.setItem(key, JSON.stringify(data));
                }
            }

            async getData(key) {
                if (this.useFirebase && this.db) {
                    const snapshot = await this.db.ref(key).once('value');
                    return snapshot.val();
                } else {
                    const data = localStorage.getItem(key);
                    return data ? JSON.parse(data) : null;
                }
            }

            onDataChange(key, callback) {
                if (this.useFirebase && this.db) {
                    this.db.ref(key).on('value', (snapshot) => {
                        callback(snapshot.val());
                    });
                } else {
                    const interval = setInterval(async () => {
                        const data = await this.getData(key);
                        callback(data);
                    }, 1000);
                    this.listeners[key] = interval;
                }
            }

            offDataChange(key) {
                if (this.useFirebase && this.db) {
                    this.db.ref(key).off();
                } else if (this.listeners[key]) {
                    clearInterval(this.listeners[key]);
                    delete this.listeners[key];
                }
            }
        }

        const dbManager = new DatabaseManager();

        // Hook para geolocalización con detección automática
        function useGeolocation() {
            const [location, setLocation] = useState(null);
            const [error, setError] = useState(null);
            const [isEnabled, setIsEnabled] = useState(false);
            const watchIdRef = useRef(null);

            useEffect(() => {
                if (!navigator.geolocation) {
                    setError("Geolocalización no soportada por este navegador");
                    setIsEnabled(false);
                    return;
                }

                watchIdRef.current = navigator.geolocation.watchPosition(
                    (position) => {
                        setLocation({
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude,
                            accuracy: position.coords.accuracy,
                            timestamp: Date.now()
                        });
                        setIsEnabled(true);
                        setError(null);
                    },
                    (err) => {
                        let errorMsg = "Error desconocido";
                        switch(err.code) {
                            case err.PERMISSION_DENIED:
                                errorMsg = "Permiso de ubicación denegado";
                                break;
                            case err.POSITION_UNAVAILABLE:
                                errorMsg = "Ubicación no disponible";
                                break;
                            case err.TIMEOUT:
                                errorMsg = "Tiempo de espera agotado";
                                break;
                        }
                        setError(errorMsg);
                        setIsEnabled(false);
                        setLocation(null);
                    },
                    { 
                        enableHighAccuracy: true, 
                        timeout: 10000, 
                        maximumAge: 0 
                    }
                );

                return () => {
                    if (watchIdRef.current !== null) {
                        navigator.geolocation.clearWatch(watchIdRef.current);
                    }
                };
            }, []);

            return { location, error, isEnabled };
        }

        // Hook para temporizador automático
        function useTimer(isRunning) {
            const [seconds, setSeconds] = useState(0);
            const intervalRef = useRef(null);
            const startTimeRef = useRef(null);

            useEffect(() => {
                if (isRunning) {
                    if (!startTimeRef.current) {
                        startTimeRef.current = Date.now();
                    }
                    
                    intervalRef.current = setInterval(() => {
                        setSeconds(s => s + 1);
                    }, 1000);
                } else {
                    if (intervalRef.current) {
                        clearInterval(intervalRef.current);
                        intervalRef.current = null;
                    }
                }

                return () => {
                    if (intervalRef.current) {
                        clearInterval(intervalRef.current);
                    }
                };
            }, [isRunning]);

            const reset = () => {
                setSeconds(0);
                startTimeRef.current = null;
            };
            
            const formatTime = () => {
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            };

            const getMinutes = () => {
                return Math.floor(seconds / 60);
            };

            return { seconds, formatTime, reset, getMinutes };
        }

        // Componente principal
        function ControlDomicilios() {
            const [userType, setUserType] = useState(null);
            const [deliveryPerson, setDeliveryPerson] = useState(null);
            const [orders, setOrders] = useState([]);
            const [waitingList, setWaitingList] = useState([]);
            const [deliveryPeople, setDeliveryPeople] = useState([]);
            const [activeTab, setActiveTab] = useState('pending');
            const { location, error: gpsError, isEnabled: gpsEnabled } = useGeolocation();

            useEffect(() => {
                loadInitialData();
                setupDataListeners();
                
                return () => {
                    dbManager.offDataChange('orders');
                    dbManager.offDataChange('waitingList');
                    dbManager.offDataChange('deliveryPeople');
                };
            }, []);

            useEffect(() => {
                if (deliveryPerson && location && gpsEnabled) {
                    updateDeliveryPersonLocation(deliveryPerson.id, location);
                }
            }, [location, deliveryPerson, gpsEnabled]);

            async function loadInitialData() {
                const savedOrders = await dbManager.getData('orders');
                const savedWaitingList = await dbManager.getData('waitingList');
                const savedDeliveryPeople = await dbManager.getData('deliveryPeople');

                if (savedOrders) setOrders(savedOrders);
                if (savedWaitingList) setWaitingList(savedWaitingList);
                if (savedDeliveryPeople) setDeliveryPeople(savedDeliveryPeople);
            }

            function setupDataListeners() {
                dbManager.onDataChange('orders', (data) => {
                    if (data) setOrders(data);
                });
                dbManager.onDataChange('waitingList', (data) => {
                    if (data) setWaitingList(data);
                });
                dbManager.onDataChange('deliveryPeople', (data) => {
                    if (data) setDeliveryPeople(data);
                });
            }

            async function updateDeliveryPersonLocation(personId, loc) {
                const updatedPeople = deliveryPeople.map(p => 
                    p.id === personId ? { 
                        ...p, 
                        location: loc, 
                        gpsEnabled: true,
                        lastUpdate: Date.now()
                    } : p
                );
                setDeliveryPeople(updatedPeople);
                await dbManager.saveData('deliveryPeople', updatedPeople);
            }

            async function addOrder(order) {
                const newOrder = {
                    ...order,
                    id: Date.now(),
                    status: 'pending',
                    createdAt: new Date().toISOString()
                };
                const updatedOrders = [...orders, newOrder];
                setOrders(updatedOrders);
                await dbManager.saveData('orders', updatedOrders);
            }

            async function updateOrderStatus(orderId, status, deliveryPersonId = null, deliveryTime = null) {
                const updatedOrders = orders.map(order => {
                    if (order.id === orderId) {
                        const updated = { ...order, status };
                        if (deliveryPersonId) updated.deliveryPersonId = deliveryPersonId;
                        if (status === 'in_delivery') {
                            updated.acceptedAt = new Date().toISOString();
                            updated.timerStarted = Date.now();
                        }
                        if (status === 'delivered') {
                            updated.deliveredAt = new Date().toISOString();
                            if (deliveryTime !== null) {
                                updated.deliveryTimeMinutes = deliveryTime;
                            }
                        }
                        return updated;
                    }
                    return order;
                });
                setOrders(updatedOrders);
                await dbManager.saveData('orders', updatedOrders);
            }

            async function joinWaitingList(person) {
                if (!gpsEnabled) {
                    alert("?? ERROR: Debes activar el GPS para unirte a la lista de espera");
                    return false;
                }
                
                const position = waitingList.length + 1;
                const newEntry = { 
                    ...person, 
                    position, 
                    joinedAt: new Date().toISOString(), 
                    gpsEnabled: true,
                    location: location 
                };
                const updatedList = [...waitingList, newEntry];
                setWaitingList(updatedList);
                await dbManager.saveData('waitingList', updatedList);
                
                if (!deliveryPeople.find(p => p.id === person.id)) {
                    const updatedPeople = [...deliveryPeople, { 
                        ...person, 
                        gpsEnabled: true, 
                        location,
                        lastUpdate: Date.now()
                    }];
                    setDeliveryPeople(updatedPeople);
                    await dbManager.saveData('deliveryPeople', updatedPeople);
                }
                return true;
            }

            async function leaveWaitingList(personId) {
                const updatedList = waitingList
                    .filter(p => p.id !== personId)
                    .map((p, idx) => ({ ...p, position: idx + 1 }));
                setWaitingList(updatedList);
                await dbManager.saveData('waitingList', updatedList);
            }

            if (!userType) {
                return <UserTypeSelector onSelect={setUserType} />;
            }

            if (userType === 'delivery' && !deliveryPerson) {
                return <DeliveryPersonLogin 
                    onLogin={setDeliveryPerson}
                    gpsEnabled={gpsEnabled}
                    gpsError={gpsError}
                />;
            }

            if (userType === 'admin') {
                return <AdminPanel 
                    orders={orders}
                    waitingList={waitingList}
                    deliveryPeople={deliveryPeople}
                    onAddOrder={addOrder}
                    onUpdateOrder={updateOrderStatus}
                    onLeaveList={leaveWaitingList}
                    activeTab={activeTab}
                    setActiveTab={setActiveTab}
                />;
            }

            return <DeliveryPanel 
                deliveryPerson={deliveryPerson}
                orders={orders.filter(o => o.deliveryPersonId === deliveryPerson.id || o.status === 'pending')}
                waitingList={waitingList}
                onUpdateOrder={updateOrderStatus}
                onJoinList={joinWaitingList}
                onLeaveList={leaveWaitingList}
                gpsEnabled={gpsEnabled}
                gpsError={gpsError}
                location={location}
            />;
        }

        function UserTypeSelector({ onSelect }) {
            return (
                <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-50 to-blue-100 p-4">
                    <div className="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full">
                        <h1 className="text-3xl font-bold text-center mb-8 text-gray-800">
                            ??? Control de Domicilios
                        </h1>
                        <div className="space-y-4">
                            <button
                                onClick={() => onSelect('admin')}
                                className="w-full bg-blue-600 text-white py-4 rounded-xl font-semibold text-lg hover:bg-blue-700 transition-all transform hover:scale-105 shadow-lg"
                            >
                                ????? Administrador
                            </button>
                            <button
                                onClick={() => onSelect('delivery')}
                                className="w-full bg-green-600 text-white py-4 rounded-xl font-semibold text-lg hover:bg-green-700 transition-all transform hover:scale-105 shadow-lg"
                            >
                                ?? Repartidor
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        function DeliveryPersonLogin({ onLogin, gpsEnabled, gpsError }) {
            const [phone, setPhone] = useState('');
            const [name, setName] = useState('');

            const handleLogin = () => {
                if (!gpsEnabled) {
                    alert("?? ERROR: Debes activar el GPS para continuar. Ve a la configuración de tu dispositivo y activa la ubicación.");
                    return;
                }
                
                if (phone && name) {
                    onLogin({ id: phone, name, phone });
                }
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-green-50 to-green-100 p-4">
                    <div className="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full">
                        <h2 className="text-2xl font-bold mb-6 text-center text-gray-800">
                            ?? Acceso Repartidor
                        </h2>
                        
                        {!gpsEnabled && (
                            <div className="mb-6 p-5 bg-red-100 border-2 border-red-500 rounded-xl gps-warning-banner">
                                <div className="flex items-start">
                                    <span className="text-3xl mr-3">??</span>
                                    <div>
                                        <p className="text-red-800 font-bold text-lg">GPS Desactivado</p>
                                        <p className="text-sm text-red-700 mt-2">
                                            {gpsError || "Por favor activa tu ubicación en la configuración del dispositivo"}
                                        </p>
                                        <p className="text-xs text-red-600 mt-2 font-semibold">
                                            ? No podrás aceptar pedidos sin GPS activo
                                        </p>
                                    </div>
                                </div>
                            </div>
                        )}

                        <div className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                    Nombre
                                </label>
                                <input
                                    type="text"
                                    value={name}
                                    onChange={(e) => setName(e.target.value)}
                                    className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                    placeholder="Tu nombre"
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                    WhatsApp
                                </label>
                                <input
                                    type="tel"
                                    value={phone}
                                    onChange={(e) => setPhone(e.target.value)}
                                    className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                    placeholder="3001234567"
                                />
                            </div>
                            <button
                                onClick={handleLogin}
                                disabled={!gpsEnabled}
                                className="w-full bg-green-600 text-white py-3 rounded-lg font-semibold hover:bg-green-700 transition-all disabled:bg-gray-400 disabled:cursor-not-allowed"
                            >
                                {gpsEnabled ? 'Ingresar' : '?? Activa el GPS para continuar'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        function AdminPanel({ orders, waitingList, deliveryPeople, onAddOrder, onUpdateOrder, onLeaveList, activeTab, setActiveTab }) {
            const [showAddModal, setShowAddModal] = useState(false);
            const [filterDate, setFilterDate] = useState('');

            const pendingOrders = orders.filter(o => o.status === 'pending');
            const inDeliveryOrders = orders.filter(o => o.status === 'in_delivery');
            const deliveredOrders = orders.filter(o => o.status === 'delivered');

            const filteredOrders = filterDate 
                ? deliveredOrders.filter(o => o.createdAt?.startsWith(filterDate))
                : deliveredOrders;

            const stats = {
                total: orders.length,
                pending: pendingOrders.length,
                inDelivery: inDeliveryOrders.length,
                delivered: deliveredOrders.length,
                avgTime: deliveredOrders.length > 0 
                    ? (deliveredOrders.reduce((sum, o) => sum + (o.deliveryTimeMinutes || 0), 0) / deliveredOrders.length).toFixed(1)
                    : 0
            };

            return (
                <div className="min-h-screen bg-gray-50">
                    <div className="bg-white shadow-lg">
                        <div className="max-w-7xl mx-auto px-4 py-6">
                            <h1 className="text-3xl font-bold text-gray-800">
                                ?? Panel Administrador
                            </h1>
                            
                            <div className="grid grid-cols-2 md:grid-cols-5 gap-4 mt-6">
                                <MetricCard icon="??" label="Total" value={stats.total} color="blue" />
                                <MetricCard icon="?" label="Pendientes" value={stats.pending} color="yellow" />
                                <MetricCard icon="??" label="En camino" value={stats.inDelivery} color="orange" />
                                <MetricCard icon="?" label="Entregados" value={stats.delivered} color="green" />
                                <MetricCard icon="??" label="Tiempo prom." value={`${stats.avgTime} min`} color="purple" />
                            </div>

                            <div className="flex space-x-4 mt-8 border-b overflow-x-auto">
                                <TabButton active={activeTab === 'pending'} onClick={() => setActiveTab('pending')}>
                                    ? Pendientes ({stats.pending})
                                </TabButton>
                                <TabButton active={activeTab === 'in_delivery'} onClick={() => setActiveTab('in_delivery')}>
                                    ?? En camino ({stats.inDelivery})
                                </TabButton>
                                <TabButton active={activeTab === 'delivered'} onClick={() => setActiveTab('delivered')}>
                                    ? Entregados ({stats.delivered})
                                </TabButton>
                                <TabButton active={activeTab === 'waiting'} onClick={() => setActiveTab('waiting')}>
                                    ?? Lista ({waitingList.length})
                                </TabButton>
                            </div>
                        </div>
                    </div>

                    <div className="max-w-7xl mx-auto px-4 py-6">
                        {activeTab === 'pending' && (
                            <div>
                                <button
                                    onClick={() => setShowAddModal(true)}
                                    className="mb-6 bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-blue-700 transition-all shadow-lg"
                                >
                                    + Agregar Pedido
                                </button>
                                <OrdersList orders={pendingOrders} deliveryPeople={deliveryPeople} type="pending" />
                            </div>
                        )}

                        {activeTab === 'in_delivery' && (
                            <OrdersList orders={inDeliveryOrders} deliveryPeople={deliveryPeople} type="in_delivery" />
                        )}

                        {activeTab === 'delivered' && (
                            <div>
                                <div className="mb-6">
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        Filtrar por fecha
                                    </label>
                                    <input
                                        type="date"
                                        value={filterDate}
                                        onChange={(e) => setFilterDate(e.target.value)}
                                        className="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                    />
                                    {filterDate && (
                                        <button
                                            onClick={() => setFilterDate('')}
                                            className="ml-2 text-blue-600 hover:text-blue-800"
                                        >
                                            Limpiar filtro
                                        </button>
                                    )}
                                </div>
                                <OrdersList orders={filteredOrders} deliveryPeople={deliveryPeople} type="delivered" />
                            </div>
                        )}

                        {activeTab === 'waiting' && (
                            <WaitingListView list={waitingList} deliveryPeople={deliveryPeople} onRemove={onLeaveList} />
                        )}
                    </div>

                    {showAddModal && (
                        <AddOrderModal onClose={() => setShowAddModal(false)} onAdd={onAddOrder} />
                    )}
                </div>
            );
        }

        function DeliveryPanel({ deliveryPerson, orders, waitingList, onUpdateOrder, onJoinList, onLeaveList, gpsEnabled, gpsError, location }) {
            const myOrders = orders.filter(o => o.deliveryPersonId === deliveryPerson.id);
            const availableOrders = orders.filter(o => o.status === 'pending');
            const inWaitingList = waitingList.find(p => p.id === deliveryPerson.id);
            const myPosition = inWaitingList?.position;

            const handleJoinList = async () => {
                if (!gpsEnabled) {
                    alert("?? ERROR: Debes activar el GPS para unirte a la lista de espera");
                    return;
                }
                const success = await onJoinList(deliveryPerson);
                if (success) {
                    alert("? Te has unido a la lista de espera exitosamente");
                }
            };

            return (
                <div className="min-h-screen bg-gray-50">
                    <div className="bg-gradient-to-r from-green-600 to-green-700 text-white shadow-lg">
                        <div className="max-w-4xl mx-auto px-4 py-6">
                            <div className="flex justify-between items-center">
                                <div>
                                    <h1 className="text-2xl font-bold">?? {deliveryPerson.name}</h1>
                                    <p className="text-green-100">?? {deliveryPerson.phone}</p>
                                </div>
                                <div className="text-right">
                                    <div className="flex items-center justify-end mb-2">
                                        <span className={`gps-indicator ${gpsEnabled ? 'bg-green-300' : 'bg-red-400'}`}></span>
                                        <span className="text-sm font-semibold">
                                            {gpsEnabled ? 'GPS Activo ?' : 'GPS Inactivo ?'}
                                        </span>
                                    </div>
                                    {myPosition && (
                                        <div className="text-lg font-bold bg-white bg-opacity-20 px-3 py-1 rounded">
                                            Posición: #{myPosition}
                                        </div>
                                    )}
                                </div>
                            </div>

                            {!gpsEnabled && (
                                <div className="mt-4 bg-red-500 bg-opacity-90 p-4 rounded-lg gps-warning-banner">
                                    <p className="font-bold text-lg">?? GPS DESACTIVADO</p>
                                    <p className="text-sm mt-1">{gpsError || "Activa tu ubicación para aceptar pedidos"}</p>
                                    <p className="text-xs mt-2 font-semibold">? No puedes aceptar pedidos ni unirte a la lista</p>
                                </div>
                            )}
                        </div>
                    </div>

                    <div className="max-w-4xl mx-auto px-4 py-6 space-y-6">
                        <div className="bg-white rounded-xl shadow-lg p-6">
                            <h2 className="text-xl font-bold mb-4">?? Lista de Espera</h2>
                            {inWaitingList ? (
                                <div className="space-y-4">
                                    <div className="bg-green-50 border-l-4 border-green-500 p-4 rounded">
                                        <p className="font-semibold text-green-800 text-lg">
                                            ? Estás en la lista - Posición #{myPosition}
                                        </p>
                                        <p className="text-sm text-green-700 mt-1">
                                            Te notificaremos cuando haya pedidos disponibles
                                        </p>
                                    </div>
                                    <button
                                        onClick={() => onLeaveList(deliveryPerson.id)}
                                        className="w-full bg-red-500 text-white py-3 rounded-lg font-semibold hover:bg-red-600 transition-all"
                                    >
                                        Salir de la lista
                                    </button>
                                </div>
                            ) : (
                                <div>
                                    {!gpsEnabled && (
                                        <div className="mb-4 p-4 bg-red-50 border-2 border-red-300 rounded-lg">
                                            <p className="text-red-800 font-bold">? GPS requerido</p>
                                            <p className="text-sm text-red-700 mt-1">
                                                Activa tu ubicación para poder unirte
                                            </p>
                                        </div>
                                    )}
                                    <button
                                        onClick={handleJoinList}
                                        disabled={!gpsEnabled}
                                        className="w-full bg-green-600 text-white py-3 rounded-lg font-semibold hover:bg-green-700 transition-all disabled:bg-gray-400 disabled:cursor-not-allowed"
                                    >
                                        {gpsEnabled ? '? Unirse a la lista' : '?? Activa el GPS para unirte'}
                                    </button>
                                </div>
                            )}
                        </div>

                        {myOrders.length > 0 && (
                            <div className="bg-white rounded-xl shadow-lg p-6">
                                <h2 className="text-xl font-bold mb-4">?? Mis Pedidos Activos</h2>
                                <div className="space-y-4">
                                    {myOrders.map(order => (
                                        <DeliveryOrderCard 
                                            key={order.id} 
                                            order={order} 
                                            onUpdate={onUpdateOrder}
                                            deliveryPersonId={deliveryPerson.id}
                                        />
                                    ))}
                                </div>
                            </div>
                        )}

                        {availableOrders.length > 0 && (
                            <div className="bg-white rounded-xl shadow-lg p-6">
                                <h2 className="text-xl font-bold mb-4">?? Pedidos Disponibles</h2>
                                {!gpsEnabled && (
                                    <div className="mb-4 bg-red-50 border-l-4 border-red-500 p-4 rounded gps-warning-banner">
                                        <p className="text-red-800 font-bold text-lg">?? GPS REQUERIDO</p>
                                        <p className="text-sm text-red-700 mt-1">
                                            Debes activar el GPS para poder aceptar pedidos
                                        </p>
                                    </div>
                                )}
                                <div className="space-y-4">
                                    {availableOrders.map(order => (
                                        <AvailableOrderCard 
                                            key={order.id} 
                                            order={order} 
                                            onAccept={() => onUpdateOrder(order.id, 'in_delivery', deliveryPerson.id)}
                                            gpsEnabled={gpsEnabled}
                                        />
                                    ))}
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        function DeliveryOrderCard({ order, onUpdate, deliveryPersonId }) {
            const isInDelivery = order.status === 'in_delivery';
            const { seconds, formatTime, reset, getMinutes } = useTimer(isInDelivery);

            const handleDeliver = () => {
                const deliveryTimeMinutes = getMinutes();
                onUpdate(order.id, 'delivered', deliveryPersonId, deliveryTimeMinutes);
                reset();
                alert(`? Pedido entregado en ${deliveryTimeMinutes} minutos`);
            };

            return (
                <div className="border-2 border-orange-300 bg-orange-50 rounded-lg p-5 hover:shadow-lg transition-shadow">
                    <div className="flex justify-between items-start mb-3">
                        <div>
                            <h3 className="font-bold text-lg">{order.customerName}</h3>
                            <p className="text-gray-600 text-sm">?? {order.address}</p>
                            <p className="text-gray-500 text-sm">?? {order.phone}</p>
                        </div>
                        <div className="text-right">
                            <span className="text-2xl font-bold text-green-600">${order.total}</span>
                        </div>
                    </div>

                    {order.items && (
                        <div className="mb-3 text-sm text-gray-700 bg-white p-2 rounded">
                            <strong>Pedido:</strong> {order.items}
                        </div>
                    )}

                    {isInDelivery && (
                        <div className="mb-4 flex justify-center">
                            <div className="timer-display">
                                ?? {formatTime()}
                            </div>
                        </div>
                    )}

                    {isInDelivery && (
                        <div className="space-y-2">
                            
                                href={`https://wa.me/${order.phone.replace(/\D/g, '')}`}
                                target="_blank"
                                rel="noopener noreferrer"
                                className="block w-full bg-green-500 text-white py-3 px-4 rounded-lg text-center font-semibold hover:bg-green-600 transition-all"
                            >
                                ?? Contactar por WhatsApp
                            </a>
                            <button
                                onClick={handleDeliver}
                                className="w-full bg-blue-600 text-white py-3 px-4 rounded-lg font-semibold hover:bg-blue-700 transition-all"
                            >
                                ? Marcar como Entregado ({getMinutes()} min)
                            </button>
                        </div>
                    )}
                </div>
            );
        }

        function AvailableOrderCard({ order, onAccept, gpsEnabled }) {
            const handleAccept = () => {
                if (!gpsEnabled) {
                    alert("?? ERROR: Debes activar el GPS para aceptar pedidos");
                    return;
                }
                onAccept();
            };

            return (
                <div className="border-2 border-blue-300 bg-blue-50 rounded-lg p-5 hover:shadow-md transition-shadow">
                    <div className="flex justify-between items-start mb-3">
                        <div>
                            <h3 className="font-bold text-lg">{order.customerName}</h3>
                            <p className="text-gray-600 text-sm">?? {order.address}</p>
                            <p className="text-gray-500 text-sm">?? {order.phone}</p>
                        </div>
                        <span className="text-2xl font-bold text-blue-600">${order.total}</span>
                    </div>

                    {order.items && (
                        <div className="mb-3 text-sm text-gray-700 bg-white p-2 rounded">
                            <strong>Pedido:</strong> {order.items}
                        </div>
                    )}

                    <button
                        onClick={handleAccept}
                        disabled={!gpsEnabled}
                        className="w-full bg-blue-600 text-white py-3 px-4 rounded-lg font-semibold hover:bg-blue-700 transition-all disabled:bg-gray-400 disabled:cursor-not-allowed"
                    >
                        {gpsEnabled ? '?? Aceptar Pedido' : '?? Activa GPS para aceptar'}
                    </button>
                </div>
            );
        }

        function WaitingListView({ list, deliveryPeople, onRemove }) {
            return (
                <div className="bg-white rounded-xl shadow-lg p-6">
                    <h2 className="text-xl font-bold mb-4">?? Lista de Espera Activa</h2>
                    {list.length === 0 ? (
                        <p className="text-gray-500 text-center py-8">No hay repartidores en espera</p>
                    ) : (
                        <div className="space-y-3">
                            {list.map(person => {
                                const deliveryPerson = deliveryPeople.find(d => d.id === person.id);
                                const gpsStatus = deliveryPerson?.gpsEnabled;
                                
                                return (
                                    <div key={person.id} className="flex items-center justify-between p-4 border-2 border-gray-200 rounded-lg hover:bg-gray-50">
                                        <div className="flex items-center space-x-4">
                                            <div className="bg-blue-600 text-white font-bold w-12 h-12 rounded-full flex items-center justify-center text-lg">
                                                #{person.position}
                                            </div>
                                            <div>
                                                <p className="font-semibold text-lg">{person.name}</p>
                                                <p className="text-sm text-gray-600">?? {person.phone}</p>
                                                <p className="text-xs text-gray-500 mt-1">
                                                    Ingresó: {new Date(person.joinedAt).toLocaleTimeString('es-CO')}
                                                </p>
                                            </div>
                                        </div>
                                        <div className="flex items-center space-x-4">
                                            <div className="flex items-center bg-white p-2 rounded-lg border">
                                                <span className={`gps-indicator ${gpsStatus ? 'bg-green-500' : 'bg-red-500'}`}></span>
                                                <span className={`text-sm font-bold ${gpsStatus ? 'text-green-700' : 'text-red-700'}`}>
                                                    {gpsStatus ? 'GPS Activo' : 'GPS Inactivo'}
                                                </span>
                                            </div>
                                            <button
                                                onClick={() => onRemove(person.id)}
                                                className="text-red-600 hover:text-red-800 font-medium px-4 py-2 hover:bg-red-50 rounded-lg border border-red-300"
                                            >
                                                Remover
                                            </button>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    )}
                </div>
            );
        }

        function OrdersList({ orders, deliveryPeople, type }) {
            if (orders.length === 0) {
                return (
                    <div className="bg-white rounded-xl shadow-lg p-8 text-center">
                        <p className="text-gray-500 text-lg">No hay pedidos en esta categoría</p>
                    </div>
                );
            }

            return (
                <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
                    {orders.map(order => {
                        const deliveryPerson = deliveryPeople.find(d => d.id === order.deliveryPersonId);
                        return (
                            <div key={order.id} className="bg-white rounded-lg shadow-md p-5 hover:shadow-lg transition-shadow border border-gray-200">
                                <div className="flex justify-between items-start mb-3">
                                    <div>
                                        <h3 className="font-bold text-lg">{order.customerName}</h3>
                                        <p className="text-gray-600 text-sm">?? {order.address}</p>
                                        <p className="text-gray-500 text-sm">?? {order.phone}</p>
                                    </div>
                                    <span className="text-xl font-bold text-green-600">${order.total}</span>
                                </div>

                                {order.items && (
                                    <p className="text-sm text-gray-700 mb-3 bg-gray-50 p-2 rounded">
                                        <strong>Pedido:</strong> {order.items}
                                    </p>
                                )}

                                {deliveryPerson && (
                                    <div className="bg-blue-50 p-3 rounded mb-3 border border-blue-200">
                                        <p className="text-sm font-semibold text-blue-800">
                                            ?? Repartidor: {deliveryPerson.name}
                                        </p>
                                    </div>
                                )}

                                {type === 'delivered' && order.deliveryTimeMinutes !== undefined && (
                                    <div className="bg-green-50 p-3 rounded border border-green-200">
                                        <p className="text-sm font-bold text-green-800">
                                            ?? Tiempo de entrega: {order.deliveryTimeMinutes} minutos
                                        </p>
                                    </div>
                                )}

                                <div className="mt-3 pt-3 border-t text-xs text-gray-500">
                                    ?? {new Date(order.createdAt).toLocaleString('es-CO')}
                                </div>
                            </div>
                        );
                    })}
                </div>
            );
        }

        function AddOrderModal({ onClose, onAdd }) {
            const [formData, setFormData] = useState({
                customerName: '',
                phone: '',
                address: '',
                items: '',
                total: ''
            });

            const handleSubmit = (e) => {
                e.preventDefault();
                if (formData.customerName && formData.phone && formData.address && formData.total) {
                    onAdd(formData);
                    onClose();
                }
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                    <div className="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6">
                        <h2 className="text-2xl font-bold mb-6">? Nuevo Pedido</h2>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <input
                                type="text"
                                placeholder="Nombre del cliente"
                                value={formData.customerName}
                                onChange={(e) => setFormData({...formData, customerName: e.target.value})}
                                className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                required
                            />
                            <input
                                type="tel"
                                placeholder="Teléfono (ej: 3001234567)"
                                value={formData.phone}
                                onChange={(e) => setFormData({...formData, phone: e.target.value})}
                                className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                required
                            />
                            <input
                                type="text"
                                placeholder="Dirección completa"
                                value={formData.address}
                                onChange={(e) => setFormData({...formData, address: e.target.value})}
                                className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                required
                            />
                            <textarea
                                placeholder="Detalle del pedido (opcional)"
                                value={formData.items}
                                onChange={(e) => setFormData({...formData, items: e.target.value})}
                                className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                rows="3"
                            />
                            <input
                                type="number"
                                placeholder="Total del pedido"
                                value={formData.total}
                                onChange={(e) => setFormData({...formData, total: e.target.value})}
                                className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                required
                            />
                            <div className="flex space-x-3">
                                <button
                                    type="button"
                                    onClick={onClose}
                                    className="flex-1 bg-gray-200 text-gray-800 py-3 rounded-lg font-semibold hover:bg-gray-300 transition-all"
                                >
                                    Cancelar
                                </button>
                                <button
                                    type="submit"
                                    className="flex-1 bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition-all"
                                >
                                    Agregar Pedido
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        function MetricCard({ icon, label, value, color }) {
            const colors = {
                blue: 'bg-blue-50 text-blue-700 border-blue-200',
                yellow: 'bg-yellow-50 text-yellow-700 border-yellow-200',
                orange: 'bg-orange-50 text-orange-700 border-orange-200',
                green: 'bg-green-50 text-green-700 border-green-200',
                purple: 'bg-purple-50 text-purple-700 border-purple-200'
            };

            return (
                <div className={`${colors[color]} p-4 rounded-xl metric-card border-2`}>
                    <div className="text-3xl mb-1">{icon}</div>
                    <div className="text-sm opacity-80 font-medium">{label}</div>
                    <div className="text-2xl font-bold mt-1">{value}</div>
                </div>
            );
        }

        function TabButton({ active, onClick, children }) {
            return (
                <button
                    onClick={onClick}
                    className={`tab-button px-6 py-3 font-medium whitespace-nowrap ${active ? 'active' : 'text-gray-600 hover:text-gray-800'}`}
                >